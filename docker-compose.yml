version: "3.0"
services:
    loadbalancer:
        build:
            context: ./haproxy
            dockerfile: haproxy_Dockerfile
            args:
                # the name of your SSL cert chain located in haproxy/
                # can also be generated by concatenating the ssl cert, intermediary cert and private key together
                SSL_CHAIN: combined_key.pem
        container_name: HAPROXY
        environment:
            # used if you wish to replace the SSL port with another HTTP port
            # bind '8051' in your ports to use this port
            # effective for a situation where HTTPs is handled by another entrypoint
            DISABLE_SSL: 'false'
            # used if the anonymous annotations feature is being hosted on a server other than
            # the one which processes PDFs
            REROUTE_ANNOT_REQUESTS: 'false'
            INITIAL_NODE_A: pdfd-tomcat
            # Sets a URL prefix for the server
            URL_PREFIX:
            # Enables management from tcp socket 4893
            # Do not enable unless your server is secure from external access
            # Add 4893:4893 to the ports section if using this
            ENABLE_TCP_MANAGEMENT: 'false'
        ports:
            # Sets the port to bind the internal 8090 port to. Follows the pattern
            # external:internal (80:8090). Internal port must either be 8050 or 4430.
            - 8090:8050
            - 8443:4430
            - 60001:60001
        restart: always
    pdfd-tomcat:
        build:
            context: .
            # Everything in the args section is customizes the docker image, ensure you put
            # all 'true' and 'false' variables inside quotes.
            args:
                # if true, includes LibreOffice conversion support
                LIBRE_SUPPORT: 'true'
                # if true, includes HTML conversion support
                HTML_SUPPORT: 'true'
                # if true, includes AutoCAD DWG, DGN support
                CAD_SUPPORT: 'true'
        # uncomment to map the static data directory to a drive outside the container
        # just replace my_external_static_data with the desired externally mapped folder.
        # volumes:
        #  - /files/my_external_data:/usr/local/apache-tomcat-9.0.6/static_data
        container_name: Blackbox
        environment:
            # Normally the cache cleanup is triggered once there is less than 1Gb
            # of space remaining on the partition, at which point files that have
            # not been accessed recently are wiped from the cache.
            # The following two settings override this behaviour.
            #
            # Any file that has not been touched within this number of minutes
            # will be wiped from the local disk cache. Cannot be smaller than 10.
            # A value of 0 is ignored entirely
            TRN_MAX_CACHE_AGE_MINUTES: 0
            # Cached content will be cleaned up until the cache occupies less space
            # than this limit
            # Cannot be smaller than 200, and a value of 0 is ignored.
            TRN_MAX_CACHED_MB: 0
            # Forces PDFNet logs to print to the console
            # TRN_FORCE_CONSOLE: 'true'
            # Prevent the server from sending the client PDF data directly, using
            # derived formats like images or .xod instead
            # TRN_DISABLE_CLIENT_PDF_ACCESS: 1
            INCLUDE_DEMO: 'true'
            TRN_PDFNET_KEY: 'demo:yzhou@pdftron.com:744f4a3d01f8f54d2769180c942be4c441fa8ba33f0bb9dad3'
            # Supports SQLITE and POSTGRES
            TRN_DB_TYPE: SQLITE
            # Supports postgresql for now
            # should be in the form host:port/databaseName?user=username&password=password
            # eg. pdftron.com:5432/pdftron?user=pdftron&password=pdftron
            TRN_DB_LINK:
            TRN_BALANCER_COOKIE_NAME: HAPROXID
            TRN_DEBUG_MODE: 'false'
            # Set required domains for document fetches
            # TRN_FETCH_REQUIRED_URL_ROOT: "www.doc.com;www.pdf.com;www.download.com"
            # Forward same domain cookies between servers
            TRN_FORWARD_CLIENT_COOKIES: 'false'
            TRN_FETCH_DOWNGRADE_HTTPS: 'true'
            TRN_DEBUG_DISABLE_CLIENT_BACKEND_SWITCH: 'true'
        ports:
            # Sets the port to bind the internal 8090 port to. Follows the pattern
            # external:internal (80:8090). Internal port must either be 8090 or 8443.
            - 8091:8090
            - 8445:8443
